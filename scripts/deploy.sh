#!/bin/bash

# ุณูุฑูุจุช ุงููุดุฑ ููุดุฑูุน ูุฒุงููุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ
# ูููู ูุฐุง ุงูุณูุฑูุจุช ุจุจูุงุก ุงูุชุทุจูู ูุชุฌููุฒู ููุฅูุชุงุฌ

echo "๐ ุจุฏุก ูุดุฑ ูุดุฑูุน ูุฒุงููุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ..."

# ุงูุชุญูู ูู ุฃููุง ูู ุงููุฑุน ุงูุฑุฆูุณู
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" != "main" ]; then
    read -p "โ๏ธ ุฃูุช ูุณุช ูู ุงููุฑุน ุงูุฑุฆูุณู (main). ูู ุชุฑุบุจ ูู ุงููุชุงุจุนุฉ ุจุงููุดุฑุ (ู/ู): " CONTINUE
    if [[ ! $CONTINUE =~ ^[ูYy]$ ]]; then
        echo "โ ุชู ุฅูุบุงุก ุงููุดุฑ"
        exit 1
    fi
fi

# ุงูุชุญูู ูู ุงูุชุบููุฑุงุช ุบูุฑ ุงููุคูุฏุฉ
if [ -n "$(git status --porcelain)" ]; then
    read -p "โ๏ธ ููุงู ุชุบููุฑุงุช ุบูุฑ ูุคูุฏุฉ ูู ุงููุณุชูุฏุน. ูู ุชุฑุบุจ ูู ุงููุชุงุจุนุฉ ุจุงููุดุฑุ (ู/ู): " CONTINUE
    if [[ ! $CONTINUE =~ ^[ูYy]$ ]]; then
        echo "โ ุชู ุฅูุบุงุก ุงููุดุฑ"
        exit 1
    fi
fi

# ุจูุงุก ุงูุนููู
echo "๐๏ธ ุจูุงุก ุชุทุจูู ุงูุนููู..."
cd ./client && npm run build
if [ $? -ne 0 ]; then
    echo "โ ุฎุทุฃ ูู ุจูุงุก ุชุทุจูู ุงูุนููู"
    exit 1
fi
echo "โ ุชู ุจูุงุก ุชุทุจูู ุงูุนููู ุจูุฌุงุญ"

# ุงูุนูุฏุฉ ุฅูู ุงููุฌูุฏ ุงูุฑุฆูุณู
cd ..

# ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ ุงููุดุฑ
DEPLOY_DIR="./deploy"
if [ ! -d "$DEPLOY_DIR" ]; then
    mkdir -p "$DEPLOY_DIR"
    echo "โ ุชู ุฅูุดุงุก ูุฌูุฏ ุงููุดุฑ ูู $DEPLOY_DIR"
else
    # ุชูุธูู ูุฌูุฏ ุงููุดุฑ
    rm -rf "$DEPLOY_DIR"/*
    echo "โ ุชู ุชูุธูู ูุฌูุฏ ุงููุดุฑ"
fi

# ูุณุฎ ูููุงุช ุงูุฎุงุฏู
echo "๐ ูุณุฎ ูููุงุช ุงูุฎุงุฏู..."
cp -r ./server/* "$DEPLOY_DIR/"
if [ $? -ne 0 ]; then
    echo "โ ุฎุทุฃ ูู ูุณุฎ ูููุงุช ุงูุฎุงุฏู"
    exit 1
fi
echo "โ ุชู ูุณุฎ ูููุงุช ุงูุฎุงุฏู ุจูุฌุงุญ"

# ูุณุฎ ูููุงุช ุงูุนููู ุงููุจููุฉ
echo "๐ ูุณุฎ ูููุงุช ุงูุนููู ุงููุจููุฉ..."
mkdir -p "$DEPLOY_DIR/public"
cp -r ./client/build/* "$DEPLOY_DIR/public/"
if [ $? -ne 0 ]; then
    echo "โ ุฎุทุฃ ูู ูุณุฎ ูููุงุช ุงูุนููู ุงููุจููุฉ"
    exit 1
fi
echo "โ ุชู ูุณุฎ ูููุงุช ุงูุนููู ุงููุจููุฉ ุจูุฌุงุญ"

# ุฅูุดุงุก ููู .env ููุฅูุชุงุฌ ุฅุฐุง ูู ููู ููุฌูุฏูุง
if [ ! -f "$DEPLOY_DIR/.env" ]; then
    echo "๐ ุฅูุดุงุก ููู .env ููุฅูุชุงุฌ..."
    echo "NODE_ENV=production
PORT=5000
MONGODB_URI=mongodb://localhost:27017/multi-store-sync
JWT_SECRET=ูู_ุจุชุบููุฑ_ูุฐุง_ุฅูู_ุณูุณูุฉ_ุนุดูุงุฆูุฉ_ุขููุฉ
JWT_EXPIRE=7d

# ููุงุชูุญ API ูุดูุจููุงู
SHOPIFY_API_KEY=ููุชุงุญ_API_ุดูุจููุงู
SHOPIFY_API_SECRET=ุงูุณุฑ_API_ุดูุจููุงู

# ููุงุชูุญ API ููุงุฒุงุฏุง
LAZADA_API_KEY=ููุชุงุญ_API_ูุงุฒุงุฏุง
LAZADA_API_SECRET=ุงูุณุฑ_API_ูุงุฒุงุฏุง

# ููุงุชูุญ API ูุดูุจู
SHOPEE_API_KEY=ููุชุงุญ_API_ุดูุจู
SHOPEE_API_SECRET=ุงูุณุฑ_API_ุดูุจู

# ููุงุชูุญ API ููููููุฑุณ
WOOCOMMERCE_API_KEY=ููุชุงุญ_API_ูููููุฑุณ
WOOCOMMERCE_API_SECRET=ุงูุณุฑ_API_ูููููุฑุณ" > "$DEPLOY_DIR/.env"
    
    echo "โ ุชู ุฅูุดุงุก ููู .env ููุฅูุชุงุฌ"
    echo "โ๏ธ ุงูุฑุฌุงุก ุชุนุฏูู ููู $DEPLOY_DIR/.env ุจููุงุชูุญ API ูุฅุนุฏุงุฏุงุช ุงูุฅูุชุงุฌ ุงูุฎุงุตุฉ ุจู"
fi

# ุฅูุดุงุก ููู README ููุฌูุฏ ุงููุดุฑ
echo "๐ ุฅูุดุงุก ููู README ููุฌูุฏ ุงููุดุฑ..."
echo "# ูุดุฑ ูุธุงู ูุฒุงููุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ

ูุญุชูู ูุฐุง ุงููุฌูุฏ ุนูู ุงููููุงุช ุงูุฌุงูุฒุฉ ููุดุฑ ูุดุฑูุน ูุฒุงููุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ.

## ูููู ุงููููุงุช

- \`./public\`: ุงููููุงุช ุงูุซุงุจุชุฉ ูุชุทุจูู ุงูุนููู
- \`./\*\`: ูููุงุช ุงูุฎุงุฏู

## ุฎุทูุงุช ุงููุดุฑ

1. ุชุซุจูุช ุงูุชุจุนูุงุช: \`npm install --production\`
2. ุชูููู ููู \`.env\` ุจูุชุบูุฑุงุช ุจูุฆุฉ ุงูุฅูุชุงุฌ
3. ุจุฏุก ุงูุฎุงุฏู: \`npm start\`

## ุชูุตูุงุช

- ุงุณุชุฎุฏู ูุฏูุฑ ุนูููุงุช ูุซู PM2 ููุญูุงุธ ุนูู ุชุดุบูู ุงูุชุทุจูู
- ูู ุจุชูููู ุฎุงุฏู ููุจ ูุซู Nginx ูุจุฑููุณู ุนูุณู
- ุชุฃูุฏ ูู ุชุซุจูุช MongoDB ูุชุดุบููู

## ุฃูุงูุฑ ูููุฏุฉ ูู PM2

- ุจุฏุก ุงูุชุทุจูู: \`pm2 start server.js --name multi-store-sync\`
- ุนุฑุถ ุงูุณุฌูุงุช: \`pm2 logs multi-store-sync\`
- ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู: \`pm2 restart multi-store-sync\`
- ุฅููุงู ุงูุชุทุจูู: \`pm2 stop multi-store-sync\`

ููุฒูุฏ ูู ุงููุนูููุงุชุ ุฑุงุฌุน ุงููุซุงุฆู ุงูุฑุณููุฉ.
" > "$DEPLOY_DIR/README.md"
echo "โ ุชู ุฅูุดุงุก ููู README ููุฌูุฏ ุงููุดุฑ"

echo "
๐ ุชู ุชุฌููุฒ ุงููุดุฑ ุจูุฌุงุญ!

ุงููููุงุช ุงููุฎุตุตุฉ ูููุดุฑ ููุฌูุฏุฉ ูู: $DEPLOY_DIR

ูุฅููุงู ุงููุดุฑ ุนูู ุฎุงุฏู ุงูุฅูุชุงุฌ:

1. ุงูุณุฎ ูุญุชููุงุช ุงููุฌูุฏ $DEPLOY_DIR ุฅูู ุฎุงุฏู ุงูุฅูุชุงุฌ ุงูุฎุงุต ุจู
2. ูู ุจุชูููู ููู .env ุจุจูุงูุงุช ุงุนุชูุงุฏ ุงูุฅูุชุงุฌ ุงูุฎุงุตุฉ ุจู
3. ูู ุจุชุซุจูุช ุงูุชุจุนูุงุช ุจุงุณุชุฎุฏุงู \`npm install --production\`
4. ุงุจุฏุฃ ุงูุฎุงุฏู ุจุงุณุชุฎุฏุงู \`npm start\` ุฃู ููุถู ุงุณุชุฎุฏุงู PM2:
   \`pm2 start server.js --name multi-store-sync\`

ุดูุฑูุง ูุงุณุชุฎุฏุงู ูุธุงู ูุฒุงููุฉ ุงููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ!
"